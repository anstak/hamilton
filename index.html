<!DOCTYPE html>
<html>
<head>
  <title>Hamilton</title>
  <link rel="stylesheet" type="text/css" href="/static/reset.css" />
  <link href="http://fonts.googleapis.com/css?family=Inconsolata:400,700" rel="stylesheet" type="text/css">
  <link rel="stylesheet" type="text/css" href="/static/style.css" />
</head>
<body>
<div class="container">
  <h1>Hamilton</h1>
  <ul id="nav">
    <li><a href="#" id="dot-open">DOT</a></li>
    <li><a href="#">+V</a></li>
    <li><a href="#">&ndash;E</a></li>
    <li><a href="#" id="save-canvas"><img src="/static/img/download.png" width="40" height="30"></a></li>
    <li><a href="#" id="share-link"><img src="/static/img/share.png" width="30" height="30"></a></li>
  </ul>
  <canvas id="hamilton-canvas" width="901px" height="601px">
  Bro, get some HTML5 Canvas.
  </canvas>
  <canvas id="capture-canvas">
  Broseph
  </canvas>

  <div id="spotlight" style="display:none;">
    <div id="wrapper">
      <div id="stage-dot">
      <h2>Import DOT description</h2>
      <form method="post" id="hamilton-dot">
        <textarea id="dot-code"></textarea>
        <input type="button" id="dot-go" value="Go" />
        <input type="button" id="reset-layout" value="Reset" />
      </form>
      </div>
      <div id="stage-img">
      <h2>Export to image.</h2>
      <img id="canvas-img" alt="Right click to save me!">
      <h3>Right click and select save as...</h3>
      </div>
      <div id="stage-share">
      <h2>Graph link created!</h2>
      <span id="permalink"><a href="">Here is a permalink to your graph</a>
        <input type="button" id="clipboard" value="Copy">
      </span>
      </div>
    </div>
  </div>
  <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
  <script type="text/javascript" src="/static/lib/ZeroClipboard.min.js"></script>
  <script type="text/javascript" src="/static/lib/Dot.js"></script>

  <script type="text/javascript" src="/static/lib/util.js"></script>
  <script type="text/javascript" src="/static/lib/Hamilton.js"></script>
  <script type="text/javascript" src="/static/lib/Vertex.js"></script>
  <script type="text/javascript" src="/static/lib/Edge.js"></script>
  <script type="text/javascript" src="/static/lib/Layout.js"></script>
  <script type="text/javascript">
    var hamilton, layout, graph, fgraph, clip; 
    fgraph = {{ graph|safe }};
    graph = fgraph['graph'] || {};
    hamilton = new Hamilton(document.getElementById('hamilton-canvas'));
    if (!(graph.vertices && graph.edges)) {
      hamilton.name = "example";
      hamilton.type = "graph";
      hamilton.addVertex(new Hamilton.Vertex({id: 'A'}));
      hamilton.addVertex('B', 225, 150);
      hamilton.addVertex('C', 200, 50);
      hamilton.addVertex('D', 150, 100);
      hamilton.addVertex('E', 225, 150);
      hamilton.addVertex('F', 200, 50);
      hamilton.addVertex('G', 150, 100);
      hamilton.addVertex('X', 225, 150);
      hamilton.addVertex('U', 200, 50);
      hamilton.addVertex('K', 150, 100);

      hamilton.addEdge('A', 'B');
      hamilton.addEdge('A', 'G');
      hamilton.addEdge('G', 'B');
      hamilton.addEdge('C', 'U');
      hamilton.addEdge('F', 'C');
      hamilton.addEdge('D', 'B');
      hamilton.addEdge('E', 'D');
      hamilton.addEdge('K', 'U');
      hamilton.addEdge('X', 'D');
      hamilton.addEdge('X', 'K');

      layout = new Layout(hamilton);
      console.log(hamilton);
      layout.layout();
      layout.applyLayout();
    } else {
      hamilton.setGraph(graph);
    }

    hamilton.draw();

    $('#dot-open').click(function() {
      $('#dot-code').val(hamilton.toDot());
      $('#stage-share').hide();
      $('#stage-img').hide();
      $('#stage-dot').show();
      $('#spotlight').fadeIn(200);
    });
    $('#stage-dot').click(function(event) { event.stopPropagation(); });
    $('#stage-share').click(function(event) { event.stopPropagation(); });
    $('#spotlight').click(function() { $(this).fadeOut(200); });

    $('#save-canvas').click(function() {
      doImageCapture(hamilton);
      $('#stage-share').hide();
      $('#stage-dot').hide();
      $('#stage-img').show();
      $('#spotlight').fadeIn(200);
    });

    $('#share-link').click(function() {
      doImageCapture(hamilton);
      $('#stage-share').show();
      $('#stage-dot').hide();
      $('#stage-img').hide();
      $('#spotlight').fadeIn(200);
    });

    $('#add-node').click(function() {
      var x = (hamilton.canvas.width-80) * Math.random();
      var y = (hamilton.canvas.height-80) * Math.random();
      hamilton.addVertex("wwq", x, y);
      hamilton.draw();
    });

    function doImageCapture(graph) {
      var maxx = -Infinity, minx = Infinity, maxy = -Infinity, miny = Infinity;
      var canvas = document.getElementById('capture-canvas');
      var context = canvas.getContext("2d");

      for (id in graph.vertices) {
        var x = graph.vertices[id].props.x,
            y = graph.vertices[id].props.y;
        if(x > maxx) maxx = x;
        if(x < minx) minx = x;
        if(y > maxy) maxy = y;
        if(y < miny) miny = y;
      }
      graph._noGrid = true;
      graph.draw();
      var imgData = graph.context.getImageData(minx-30, miny-30, (maxx-minx+60), (maxy-miny+60));
      graph._noGrid = false;
      graph.draw();
      canvas.width = (maxx-minx+60);
      canvas.height = (maxy-miny+60);
      context.putImageData(imgData, 0,0);

      document.getElementById('canvas-img').src = canvas.toDataURL();

      clip = new ZeroClipboard($('#clipboard'), {
        moviePath: "/static/ZeroClipboard.swf"    
      });
    }
  </script>
</div>
</body>
</html>
